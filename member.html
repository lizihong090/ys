<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>會員頁面 - 電話號碼管理</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAq8_DC6kLl2bmqNKvv1q7ghZr0-7Ej4_k",
    authDomain: "yesh-87d8e.firebaseapp.com",
    projectId: "yesh-87d8e",
    storageBucket: "yesh-87d8e.firebasestorage.app",
    messagingSenderId: "969667016769",
    appId: "1:969667016769:web:6715fb42ed5daaa5b66ec0",
    measurementId: "G-ETRBPCH2XN"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      document.getElementById("welcomeMsg").innerText = `歡迎，${user.email}`;
    } else {
      alert("請先登入！");
      window.location.href = "login.html";
    }
  });

  window.logout = () => {
    signOut(auth).then(() => {
      window.location.href = "login.html";
    });
  };

  window.addPhoneNumber = async () => {
    const phone = prompt("請輸入電話號碼 (09xxxxxxxx)：");
    if (!phone) return;

    const phoneRegex = /^09\d{8}$/;
    if (!phoneRegex.test(phone)) {
      alert("電話號碼格式錯誤，請輸入09開頭共10碼的號碼");
      return;
    }

    try {
      const userDoc = doc(db, "users", currentUser.uid);
      // 只加入，不更新已存在的號碼 (若已有可重複加入)
      await updateDoc(userDoc, {
        phones: arrayUnion({
          number: phone,
          addedAt: new Date().toISOString(),
          addedBy: currentUser.email
        })
      });
      alert("電話號碼已加入！");
    } catch (error) {
      if (error.code === 'not-found') {
        // 如果文件不存在，先建立再加入
        await setDoc(userDoc, {
          phones: [{
            number: phone,
            addedAt: new Date().toISOString(),
            addedBy: currentUser.email
          }]
        });
        alert("電話號碼已加入！");
      } else {
        alert("儲存失敗：" + error.message);
      }
    }
  };

  window.searchPhoneNumber = async () => {
    const phone = prompt("請輸入欲查詢的電話號碼 (09xxxxxxxx)：");
    if (!phone) return;

    const phoneRegex = /^09\d{8}$/;
    if (!phoneRegex.test(phone)) {
      alert("電話號碼格式錯誤，請輸入09開頭共10碼的號碼");
      return;
    }

    try {
      const userDoc = doc(db, "users", currentUser.uid);
      const docSnap = await getDoc(userDoc);
      if (docSnap.exists()) {
        const data = docSnap.data();
        if (data.phones && data.phones.some(p => p.number === phone)) {
          alert(`電話號碼 ${phone} 已存在`);
        } else {
          alert(`電話號碼 ${phone} 不存在`);
        }
      } else {
        alert("尚無任何電話號碼資料");
      }
    } catch (error) {
      alert("查詢失敗：" + error.message);
    }
  };
</script>
</head>
<body>
  <h1 id="welcomeMsg">載入中...</h1>
  <button onclick="logout()">登出</button>
  <hr />
  <button onclick="addPhoneNumber()">加入電話號碼</button>
  <button onclick="searchPhoneNumber()">查詢電話號碼</button>
</body>
</html>
