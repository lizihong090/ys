<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>會員頁面</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
  import { getFirestore, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAq8_DC6kLl2bmqNKvv1q7ghZr0-7Ej4_k",
    authDomain: "yesh-87d8e.firebaseapp.com",
    projectId: "yesh-87d8e",
    storageBucket: "yesh-87d8e.firebasestorage.app",
    messagingSenderId: "969667016769",
    appId: "1:969667016769:web:6715fb42ed5daaa5b66ec0",
    measurementId: "G-ETRBPCH2XN"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
    } else {
      alert("請先登入！");
      window.location.href = "login.html";
    }
  });

  window.showAddPhoneDialog = () => {
    const phone = prompt("請輸入電話號碼 (09xxxxxxxx):");
    if (phone === null) return; // 使用者取消輸入

    const phoneTrimmed = phone.trim();
    const phoneRegex = /^09\d{8}$/;
    if (!phoneRegex.test(phoneTrimmed)) {
      alert("電話號碼格式錯誤，請輸入09開頭共10碼的號碼");
      return;
    }

    savePhoneNumber(phoneTrimmed);
  };

  async function savePhoneNumber(phone) {
    if (!currentUser) {
      alert("使用者尚未登入！");
      return;
    }

    try {
      const userDocRef = doc(db, "users", currentUser.uid);

      // 將電話號碼加入陣列 phones (新增不覆蓋)
      await updateDoc(userDocRef, {
        phones: arrayUnion({ number: phone, addedAt: new Date().toISOString() })
      });

      alert("電話號碼已加入！");
    } catch (error) {
      alert("儲存電話號碼時發生錯誤：" + error.message);
    }
  }
</script>
</head>
<body>
  <h1>會員頁面</h1>
  <button onclick="showAddPhoneDialog()">加入會員電話號碼</button>
  <br /><br />
  <button onclick="window.location.href='search.html'">進入查詢電話號碼頁面</button>
  <br /><br />
  <button onclick="auth.signOut().then(() => window.location.href='login.html')">登出</button>
</body>
</html>
