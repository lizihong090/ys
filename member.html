<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Firebase 會員管理與點餐系統</title>
  <script type="module">
    // Firebase v9+ Modular SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyAq8_DC6kLl2bmqNKvv1q7ghZr0-7Ej4_k",
      authDomain: "yesh-87d8e.firebaseapp.com",
      projectId: "yesh-87d8e",
      storageBucket: "yesh-87d8e.appspot.com",
      messagingSenderId: "969667016769",
      appId: "1:969667016769:web:6715fb42ed5daaa5b66ec0",
      measurementId: "G-ETRBPCH2XN"
    };

    // 初始化
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // 註冊
    window.register = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        alert('註冊成功');
        await addDoc(collection(db, "users"), { uid: currentUser.uid, email, phoneNumber: "" });
      } catch (error) {
        alert(error.message);
      }
    };

    // 登入
    window.login = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        alert('登入成功');
      } catch (error) {
        alert(error.message);
      }
    };

    // 登出
    window.logout = async () => {
      try {
        await signOut(auth);
        currentUser = null;
        alert('已登出');
      } catch (error) {
        alert(error.message);
      }
    };

    // 儲存電話號碼
    window.savePhoneNumber = async () => {
      const phoneNumber = document.getElementById('phoneNumber').value;
      if (!currentUser) {
        alert("請先登入");
        return;
      }
      const querySnapshot = await getDocs(collection(db, "users"));
      querySnapshot.forEach(async (docSnapshot) => {
        if (docSnapshot.data().uid === currentUser.uid) {
          const userDocRef = doc(db, "users", docSnapshot.id);
          await updateDoc(userDocRef, { phoneNumber });
          alert("電話號碼已儲存");
        }
      });
    };

    // 讀取會員資料
    window.getUsers = async () => {
      const querySnapshot = await getDocs(collection(db, "users"));
      let usersList = "";
      querySnapshot.forEach((doc) => {
        const user = doc.data();
        usersList += `Email: ${user.email}, Phone: ${user.phoneNumber || "未填寫"}<br>`;
      });
      document.getElementById("userList").innerHTML = usersList;
    };

    // 點餐功能：更新 Firestore "orders" 欄位
    window.orderItem = async (item) => {
      if (!currentUser) {
        alert("請先登入才能點餐");
        return;
      }
      const querySnapshot = await getDocs(collection(db, "users"));
      querySnapshot.forEach(async (docSnapshot) => {
        if (docSnapshot.data().uid === currentUser.uid) {
          const userDocRef = doc(db, "users", docSnapshot.id);
          await updateDoc(userDocRef, {
            orders: arrayUnion(item)
          });
          alert(`您點了：${item}`);
        }
      });
    };
  </script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { margin: 5px; padding: 10px; }
    .button-group button { margin: 5px; }
  </style>
</head>
<body>
  <h1>Firebase 會員管理與點餐系統</h1>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="密碼">
  <button onclick="register()">註冊</button>
  <button onclick="login()">登入</button>
  <button onclick="logout()">登出</button>
  <br><br>
  <input type="text" id="phoneNumber" placeholder="電話號碼">
  <button onclick="savePhoneNumber()">儲存電話號碼</button>
  <br><br>
  <button onclick="getUsers()">讀取會員資料</button>
  <div id="userList"></div>

  <h2>點餐選單</h2>
  <div class="button-group">
    <button onclick="orderItem('米血')"><i class="fas fa-utensils"></i> 米血</button>
    <button onclick="orderItem('薯條')"><i class="fas fa-utensils"></i> 薯條</button>
    <button onclick="orderItem('雞塊')"><i class="fas fa-utensils"></i> 雞塊</button>
    <button onclick="orderItem('甜不辣')"><i class="fas fa-utensils"></i> 甜不辣</button>
  </div>
</body>
</html>
